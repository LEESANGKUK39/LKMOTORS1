<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LKMOTORS ERP - í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f1f5f9; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .hidden { display: none !important; }
        input { border: 1px solid #e2e8f0; padding: 10px; border-radius: 10px; outline: none; }
        input:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
        
        /* ì¸ì‡„ ìµœì í™” ìŠ¤íƒ€ì¼ */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; border:none; }
            .no-print { display: none !important; }
        }
        .bill-table th, .bill-table td { border: 1px solid #000; padding: 6px; text-align: center; }
    </style>
</head>
<body>

    <header id="admin-header" class="hidden bg-slate-900 text-white p-4 shadow-xl sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 onclick="switchTab('tab-repair')" class="cursor-pointer font-black italic text-2xl text-blue-400 hover:scale-105 transition">LKMOTORS ERP</h1>
            <div class="flex gap-1 text-sm font-bold">
                <button onclick="switchTab('tab-repair')" class="px-4 py-2 hover:bg-slate-800 rounded-lg">ì •ë¹„/ê²€ìƒ‰</button>
                <button onclick="switchTab('tab-booking')" class="px-4 py-2 hover:bg-slate-800 rounded-lg">ì˜ˆì•½í˜„í™©</button>
                <button onclick="switchTab('tab-stock')" class="px-4 py-2 hover:bg-slate-800 rounded-lg text-green-400">ë¶€í’ˆì¬ê³ </button>
                <button onclick="location.reload()" class="bg-red-600 px-3 py-2 rounded-lg ml-2 text-white">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4">
        
        <section id="login-section" class="max-w-md mx-auto bg-white p-10 rounded-[40px] shadow-2xl mt-20 text-center">
            <h2 class="text-3xl font-black mb-8 italic text-slate-800">STAFF LOGIN</h2>
            <div class="flex flex-col gap-4">
                <input type="text" id="login-id" placeholder="ID (sansay333)" class="text-lg">
                <input type="password" id="login-pw" placeholder="Password" class="text-lg">
                <button onclick="handleMainLogin()" class="w-full py-5 bg-slate-900 text-white font-black rounded-2xl shadow-lg hover:bg-black transition">ì‹œìŠ¤í…œ ì ‘ì†</button>
            </div>
        </section>

        <section id="tab-repair" class="tab-content space-y-4">
            <div class="bg-white p-6 rounded-3xl shadow-md border-b-4 border-slate-900">
                <div class="flex gap-2">
                    <input type="text" id="search-car" placeholder="ì°¨ëŸ‰ë²ˆí˜¸ ì…ë ¥ í›„ [ì—”í„°] ë˜ëŠ” [ì¡°íšŒ]" class="flex-1 font-black text-2xl p-4 bg-slate-50 border-2 border-slate-200 rounded-2xl focus:border-blue-500">
                    <button onclick="searchCarAdmin()" class="px-12 bg-blue-600 text-white rounded-2xl font-black text-xl shadow-lg hover:bg-blue-700">ë°ì´í„° ì¡°íšŒ</button>
                </div>
            </div>

            <div id="repair-admin-area" class="hidden space-y-4">
                <div id="print-area" class="bg-white p-8 rounded-3xl shadow-xl border">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 bg-slate-50 p-6 rounded-2xl border-2 border-dashed border-slate-200">
                        <div class="flex flex-col"><label class="text-[10px] font-bold text-slate-400 uppercase">ì°¨ëŸ‰ë²ˆí˜¸</label><input type="text" id="info-car-num" class="font-black text-lg bg-transparent border-none" readonly></div>
                        <div class="flex flex-col"><label class="text-[10px] font-bold text-slate-400 uppercase">ì°¨ì£¼ëª…</label><input type="text" id="info-owner" placeholder="ì´ë¦„ ì…ë ¥" class="font-bold border-slate-200"></div>
                        <div class="flex flex-col"><label class="text-[10px] font-bold text-slate-400 uppercase">ì—°ë½ì²˜</label><input type="text" id="info-phone" placeholder="010-0000-0000" class="font-bold border-slate-200"></div>
                        <div class="flex flex-col"><label class="text-[10px] font-bold text-slate-400 uppercase">ëˆ„ì  ì£¼í–‰ê±°ë¦¬(km)</label><input type="number" id="info-mileage" class="font-black text-blue-600 border-slate-200"></div>
                    </div>

                    <div class="flex justify-between items-end mb-4 border-b-2 border-slate-900 pb-2">
                        <h2 class="text-2xl font-black italic">REPAIR INVOICE</h2>
                        <div class="flex gap-2 mb-1">
                            <input type="date" id="r-date" class="text-xs">
                            <input type="text" id="r-staff" placeholder="ì •ë¹„ì‚¬" class="text-xs w-20">
                        </div>
                    </div>

                    <table class="w-full border-collapse border border-slate-400 text-sm mb-4">
                        <thead>
                            <tr class="bg-slate-100">
                                <th class="border border-slate-400 p-2 w-12">No</th>
                                <th class="border border-slate-400 p-2">í’ˆë²ˆ ë° ë¶€í’ˆ/ì‘ì—…ë‚´ìš©</th>
                                <th class="border border-slate-400 p-2 w-16">ìˆ˜ëŸ‰</th>
                                <th class="border border-slate-400 p-2 w-32">ë‹¨ê°€</th>
                                <th class="border border-slate-400 p-2 w-32">ê³µê¸‰ê°€ì•¡</th>
                                <th class="border border-slate-400 p-2 w-32">ê³µì„(ê¸°ìˆ ë£Œ)</th>
                                <th class="border border-slate-400 p-2 w-10 no-print"></th>
                            </tr>
                        </thead>
                        <tbody id="repair-items-container"></tbody>
                        <tfoot>
                            <tr class="bg-blue-50 font-black text-lg">
                                <td colspan="4" class="border border-slate-400 p-4 text-right">ì´ í•©ê³„ ê¸ˆì•¡ (VAT ë³„ë„) :</td>
                                <td colspan="3" id="total-display" class="border border-slate-400 p-4 text-right text-blue-700">â‚© 0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="flex gap-4 no-print">
                    <button onclick="addRow()" class="px-8 bg-slate-200 font-bold rounded-xl hover:bg-slate-300">ì¤„ ì¶”ê°€</button>
                    <button onclick="saveDetailedRepair()" class="flex-1 py-5 bg-slate-900 text-white rounded-2xl font-black text-xl shadow-xl hover:bg-black transition">ì •ë¹„ ì™„ë£Œ ë° ë°ì´í„° ì €ì¥</button>
                    <button onclick="window.print()" class="px-8 bg-slate-700 text-white font-bold rounded-xl">ğŸ“„ ëª…ì„¸ì„œ ì¸ì‡„</button>
                </div>

                <div class="mt-12 no-print">
                    <h4 class="font-black text-slate-800 text-xl italic mb-6 border-l-8 border-blue-500 pl-3 uppercase">10-Year Repair History</h4>
                    <div id="repair-history-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </section>

        <section id="tab-stock" class="tab-content space-y-4">
            <div class="bg-white p-8 rounded-3xl shadow-md border-b-4 border-green-500">
                <h3 class="text-xl font-black mb-6 text-green-600 italic">INVENTORY CONTROL</h3>
                <div class="grid grid-cols-2 md:grid-cols-6 gap-3">
                    <input type="text" id="stock-pn" placeholder="í’ˆë²ˆ(PN)" class="font-bold">
                    <input type="text" id="stock-name" placeholder="ë¶€í’ˆëª…">
                    <input type="number" id="stock-in-price" placeholder="ì…ê³ ê°€">
                    <input type="number" id="stock-out-price" placeholder="ì¶œê³ ê°€">
                    <input type="number" id="stock-count" placeholder="ìˆ˜ëŸ‰">
                    <button onclick="saveStock()" class="bg-green-600 text-white rounded-xl font-bold py-3 hover:bg-green-700">ì¬ê³  ë“±ë¡</button>
                </div>
            </div>
            <div class="bg-white rounded-3xl shadow-xl overflow-hidden border">
                <table class="w-full text-sm">
                    <thead class="bg-slate-800 text-white">
                        <tr><th class="p-4">í’ˆë²ˆ(PN)</th><th class="p-4 text-left">ë¶€í’ˆëª…</th><th class="p-4">í˜„ì¬ê³ </th><th class="p-4">ì…ê³ ë‹¨ê°€</th><th class="p-4 text-red-400">ì •ë¹„ë‹¨ê°€</th></tr>
                    </thead>
                    <tbody id="stock-table-body" class="divide-y text-center"></tbody>
                </table>
            </div>
        </section>

        <section id="tab-booking" class="tab-content space-y-4">
            <div class="bg-white p-6 rounded-3xl shadow-md">
                <h3 class="text-xl font-black mb-4 italic">REPAIR RESERVATION</h3>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                    <input type="date" id="book-date">
                    <input type="time" id="book-time">
                    <input type="text" id="book-car" placeholder="ì°¨ëŸ‰ë²ˆí˜¸" class="uppercase font-bold">
                    <input type="text" id="book-desc" placeholder="ì˜ˆì•½ ë‚´ìš©">
                    <button onclick="saveBooking()" class="bg-blue-600 text-white rounded-xl font-bold">ì˜ˆì•½ ì €ì¥</button>
                </div>
            </div>
            <div id="booking-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </section>

    </main>

    <script>
        // íŒŒì´ì–´ë² ì´ìŠ¤ ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyDhTPGNKNm38PSBdATs9lks0lYu52QrP3A",
            authDomain: "lkmotors-246f1.firebaseapp.com",
            databaseURL: "https://lkmotors-246f1-default-rtdb.firebaseio.com",
            projectId: "lkmotors-246f1",
            storageBucket: "lkmotors-246f1.firebasestorage.app",
            messagingSenderId: "389443224",
            appId: "1:389443224:web:c9b78c1afd3abc1c262aed"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let searchTargetCar = "";
        let currentAdmin = null;

        // ë¡œê·¸ì¸
        function handleMainLogin() {
            const id = document.getElementById('login-id').value.trim();
            const pw = document.getElementById('login-pw').value.trim();
            if(id === "sansay333" && pw === "aa272728") {
                currentAdmin = { name: "ì‚¬ì¥ë‹˜", id: "master" };
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('admin-header').classList.remove('hidden');
                switchTab('tab-repair');
            } else { alert("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."); }
        }

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'tab-stock') loadStocks();
            if(id === 'tab-booking') loadBookings();
        }

        // [ì¡°íšŒ ê¸°ëŠ¥] ì°¨ì£¼ ì •ë³´ ë° 10ë…„ ì´ë ¥ ê²€ìƒ‰
        async function searchCarAdmin() {
            searchTargetCar = document.getElementById('search-car').value.toUpperCase().trim();
            if(!searchTargetCar) { alert("ì°¨ëŸ‰ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }

            document.getElementById('repair-admin-area').classList.remove('hidden');
            document.getElementById('info-car-num').value = searchTargetCar;
            document.getElementById('r-date').value = new Date().toISOString().substring(0, 10);
            
            // 1. ì°¨ì£¼ ì •ë³´ ë¡œë“œ (ê³¼ê±° 10ë…„ ë°ì´í„° ê¸°ë°˜)
            database.ref('cars/' + searchTargetCar).once('value', snap => {
                const info = snap.val();
                if(info) {
                    document.getElementById('info-owner').value = info.owner || "";
                    document.getElementById('info-phone').value = info.phone || "";
                    document.getElementById('info-mileage').value = info.mileage || 0;
                } else {
                    document.getElementById('info-owner').value = "";
                    document.getElementById('info-phone').value = "";
                    document.getElementById('info-mileage').value = "";
                }
            });

            // 2. ëª…ì„¸ì„œ ì…ë ¥ì¤„ ì´ˆê¸°í™”
            document.getElementById('repair-items-container').innerHTML = '';
            for(let i=0; i<5; i++) addRow();
            
            // 3. 10ë…„ ì •ë¹„ ì´ë ¥ ë¡œë“œ
            loadRepairHistory(searchTargetCar);
        }

        // ëª…ì„¸ì„œ ì¤„ ì¶”ê°€
        function addRow() {
            const container = document.getElementById('repair-items-container');
            const rowCount = container.children.length + 1;
            const tr = document.createElement('tr');
            tr.className = "item-row";
            tr.innerHTML = `
                <td class="border border-slate-400 p-2 text-center bg-slate-50">${rowCount}</td>
                <td class="border border-slate-400 p-0"><input type="text" class="w-full border-none p-2 item-key" placeholder="í’ˆë²ˆ ë˜ëŠ” ë¶€í’ˆëª…"></td>
                <td class="border border-slate-400 p-0"><input type="number" value="1" class="w-full border-none p-2 text-center item-qty" oninput="updateRowCalc(this)"></td>
                <td class="border border-slate-400 p-0"><input type="number" placeholder="0" class="w-full border-none p-2 text-right item-part" oninput="updateRowCalc(this)"></td>
                <td class="border border-slate-400 p-2 text-right font-bold bg-slate-50 item-subtotal">0</td>
                <td class="border border-slate-400 p-0"><input type="number" placeholder="0" class="w-full border-none p-2 text-right item-labor" oninput="updateRowCalc(this)"></td>
                <td class="border border-slate-400 p-2 text-center no-print"><button onclick="this.parentElement.parentElement.remove(); calcFinalTotal();" class="text-red-500 font-bold">Ã—</button></td>
            `;
            container.appendChild(tr);
        }

        function updateRowCalc(input) {
            const row = input.closest('tr');
            const qty = parseInt(row.querySelector('.item-qty').value) || 0;
            const part = parseInt(row.querySelector('.item-part').value) || 0;
            row.querySelector('.item-subtotal').innerText = (qty * part).toLocaleString();
            calcFinalTotal();
        }

        function calcFinalTotal() {
            let total = 0;
            document.querySelectorAll('.item-row').forEach(row => {
                const qty = parseInt(row.querySelector('.item-qty').value) || 0;
                const part = parseInt(row.querySelector('.item-part').value) || 0;
                const labor = parseInt(row.querySelector('.item-labor').value) || 0;
                total += (qty * part) + labor;
            });
            document.getElementById('total-display').innerText = "â‚© " + total.toLocaleString();
            return total;
        }

        // [ì €ì¥ ê¸°ëŠ¥] ì°¨ì£¼ì •ë³´ ì—…ë°ì´íŠ¸ + ì •ë¹„ê¸°ë¡ ì €ì¥ + ì¬ê³  ìë™ ì°¨ê°
        async function saveDetailedRepair() {
            const carNum = searchTargetCar;
            const owner = document.getElementById('info-owner').value;
            const phone = document.getElementById('info-phone').value;
            const mileage = document.getElementById('info-mileage').value;
            const date = document.getElementById('r-date').value;
            const staff = document.getElementById('r-staff').value || currentAdmin.name;

            // 1. ì°¨ì£¼/ì°¨ëŸ‰ ê¸°ë³¸ ì •ë³´ ì—…ë°ì´íŠ¸
            await database.ref('cars/' + carNum).update({ owner, phone, mileage });

            const items = [];
            const rows = document.querySelectorAll('.item-row');
            
            for (let row of rows) {
                const key = row.querySelector('.item-key').value.trim();
                const qty = parseInt(row.querySelector('.item-qty').value) || 0;
                const part = parseInt(row.querySelector('.item-part').value) || 0;
                const labor = parseInt(row.querySelector('.item-labor').value) || 0;

                if(key) {
                    items.push({ name: key, quantity: qty, partPrice: part, laborPrice: labor });
                    // ì¬ê³  ìë™ ì°¨ê° í˜¸ì¶œ
                    await deductStock(key, qty);
                }
            }

            // 2. ì •ë¹„ ë‚´ì—­ ì €ì¥
            await database.ref('repairs/' + carNum).push({
                date, staff, items, mileage, total: calcFinalTotal(), createdAt: Date.now()
            });

            alert("ëª…ì„¸ì„œ ì €ì¥ ë° ì¬ê³  ì°¨ê°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            loadRepairHistory(carNum);
        }

        // ì§€ëŠ¥í˜• ì¬ê³  ì°¨ê° (í’ˆë²ˆ ì¼ì¹˜ í™•ì¸ -> ë¶€í’ˆëª… ì¼ì¹˜ í™•ì¸)
        async function deductStock(searchKey, qty) {
            const snapshot = await database.ref('stocks').once('value');
            const stocks = snapshot.val();
            if(!stocks) return;

            for(let id in stocks) {
                if(id === searchKey || stocks[id].name === searchKey) {
                    const newCount = (parseInt(stocks[id].count) || 0) - qty;
                    await database.ref('stocks/' + id).update({ count: newCount });
                    break;
                }
            }
        }

        // ì •ë¹„ ì´ë ¥ ë¶ˆëŸ¬ì˜¤ê¸° (10ë…„ ë°ì´í„° ê°€ë…ì„±)
        function loadRepairHistory(car) {
            database.ref('repairs/' + car).limitToLast(100).once('value', snap => {
                const data = snap.val();
                let html = "";
                if(data) {
                    Object.values(data).reverse().forEach(r => {
                        html += `
                        <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 hover:border-blue-500 transition">
                            <div class="flex justify-between items-start border-b pb-2 mb-3">
                                <span class="font-black text-slate-700">${r.date} <span class="text-[10px] text-slate-400 font-normal">(${r.staff})</span></span>
                                <span class="font-black text-blue-600">â‚© ${Number(r.total).toLocaleString()}</span>
                            </div>
                            <div class="text-xs space-y-1 text-slate-600">
                                ${r.items.map(i => `â€¢ ${i.name} (x${i.quantity})`).join('<br>')}
                            </div>
                            <p class="text-[10px] text-right mt-3 text-slate-300 font-bold italic">${r.mileage || 0} km ì‹œì </p>
                        </div>`;
                    });
                }
                document.getElementById('repair-history-list').innerHTML = html || "<p class='col-span-2 text-center text-slate-400 py-10'>ê²€ìƒ‰ëœ ê³¼ê±° ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
            });
        }

        // [ì¬ê³  ë° ì˜ˆì•½ ê¸°ë³¸ í•¨ìˆ˜]
        function saveStock() {
            const pn = document.getElementById('stock-pn').value.trim();
            const name = document.getElementById('stock-name').value.trim();
            const count = parseInt(document.getElementById('stock-count').value) || 0;
            if(!pn || !name) return;
            database.ref('stocks/' + pn).set({
                pn, name, count,
                inPrice: document.getElementById('stock-in-price').value,
                outPrice: document.getElementById('stock-out-price').value
            }).then(() => { alert("ì¬ê³  ë“±ë¡ ì™„ë£Œ"); loadStocks(); });
        }

        function loadStocks() {
            database.ref('stocks').once('value', snap => {
                const data = snap.val();
                let html = "";
                for(let k in data) {
                    html += `<tr class="hover:bg-slate-50">
                        <td class="p-3 font-mono text-xs">${data[k].pn}</td>
                        <td class="p-3 text-left font-bold">${data[k].name}</td>
                        <td class="p-3 font-black ${data[k].count < 5 ? 'text-red-500':'text-blue-600'}">${data[k].count}</td>
                        <td class="p-3">â‚©${Number(data[k].inPrice).toLocaleString()}</td>
                        <td class="p-3 text-red-500 font-bold">â‚©${Number(data[k].outPrice).toLocaleString()}</td>
                    </tr>`;
                }
                document.getElementById('stock-table-body').innerHTML = html;
            });
        }

        function saveBooking() {
            const date = document.getElementById('book-date').value;
            const time = document.getElementById('book-time').value;
            const car = document.getElementById('book-car').value.toUpperCase();
            if(!date || !car) return;
            database.ref('bookings').push({ date, time, car, desc: document.getElementById('book-desc').value, status: 'ëŒ€ê¸°' })
            .then(() => { alert("ì˜ˆì•½ ì €ì¥ ì™„ë£Œ"); loadBookings(); });
        }

        function loadBookings() {
            database.ref('bookings').once('value', snap => {
                const data = snap.val();
                let html = "";
                for(let k in data) {
                    html += `<div class="p-5 bg-white rounded-3xl shadow-sm border-l-8 border-blue-600">
                        <div class="flex justify-between items-center"><span class="font-black text-xl">${data[k].car}</span><span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full font-bold">ëŒ€ê¸°</span></div>
                        <p class="text-sm font-bold text-slate-500 mt-1">${data[k].date} ${data[k].time}</p>
                        <p class="text-sm mt-2 text-slate-700 bg-slate-50 p-3 rounded-xl">${data[k].desc}</p>
                    </div>`;
                }
                document.getElementById('booking-list').innerHTML = html || "<p class='col-span-2 text-center text-slate-400'>í™•ì •ëœ ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
            });
        }
    </script>
</body>
</html>
