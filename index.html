<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LKMOTORS ERP - 통합 관리 시스템</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="bg-gray-100">

    <header id="admin-header" class="hidden bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <h1 class="font-black italic text-xl text-blue-400">LKMOTORS ERP</h1>
            <div class="flex gap-4 text-xs md:text-sm font-bold overflow-x-auto">
                <button onclick="switchTab('tab-repair')" class="whitespace-nowrap hover:text-blue-400">정비/검색</button>
                <button onclick="switchTab('tab-booking')" class="whitespace-nowrap hover:text-blue-400">예약관리</button>
                <button onclick="switchTab('tab-stock')" class="whitespace-nowrap hover:text-blue-400">부품/재고</button>
                <button id="master-only-btn" onclick="switchTab('tab-staff')" class="hidden whitespace-nowrap text-red-400">직원/승인관리</button>
                <button onclick="location.reload()" class="bg-red-500 px-3 py-1 rounded whitespace-nowrap">로그아웃</button>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-4">
        <section id="login-section" class="max-w-md mx-auto bg-white p-8 rounded-3xl shadow-2xl mt-20">
            <h2 id="login-title" class="text-2xl font-black text-center mb-8 italic">STAFF ACCESS</h2>
            <div id="login-inputs" class="space-y-4">
                <input type="text" id="login-id" placeholder="아이디" class="w-full p-4 border rounded-xl outline-none">
                <input type="password" id="login-pw" placeholder="비밀번호" class="w-full p-4 border rounded-xl outline-none">
                <div id="reg-extra-fields" class="hidden space-y-4">
                    <input type="text" id="reg-name" placeholder="이름 (실명)" class="w-full p-4 border rounded-xl outline-none bg-blue-50">
                </div>
                <button id="main-btn" onclick="handleMainLogin()" class="w-full py-4 bg-slate-900 text-white font-bold rounded-xl shadow-lg">로그인</button>
                <button id="switch-btn" onclick="toggleRegisterMode()" class="w-full text-blue-500 text-sm font-bold">신규 직원 가입 신청하기</button>
            </div>
        </section>

        <section id="tab-staff" class="tab-content space-y-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm text-left">
                <h3 class="text-xl font-black mb-4 border-l-4 border-red-500 pl-2">승인 대기 직원 목록</h3>
                <div id="pending-staff-list" class="divide-y">
                    </div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm text-left">
                <h3 class="text-xl font-black mb-4 border-l-4 border-gray-500 pl-2">전체 직원 명단</h3>
                <div id="active-staff-list" class="divide-y"></div>
            </div>
        </section>

        <section id="tab-repair" class="tab-content active">/* 이전 코드와 동일 */</section>
        <section id="tab-booking" class="tab-content">/* 이전 코드와 동일 */</section>
        <section id="tab-stock" class="tab-content">/* 이전 코드와 동일 */</section>

    </main>

    <script>
        const firebaseConfig = { /* 관리자님의 파이어베이스 설정 */ };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let isRegisterMode = false;
        let currentAdmin = null;

        function toggleRegisterMode() {
            isRegisterMode = !isRegisterMode;
            document.getElementById('login-title').innerText = isRegisterMode ? "STAFF REGISTER" : "STAFF ACCESS";
            document.getElementById('reg-extra-fields').classList.toggle('hidden');
            document.getElementById('main-btn').innerText = isRegisterMode ? "가입 신청하기" : "로그인";
            document.getElementById('switch-btn').innerText = isRegisterMode ? "로그인 화면으로 돌아가기" : "신규 직원 가입 신청하기";
        }

        function handleMainLogin() {
            const id = document.getElementById('login-id').value.trim();
            const pw = document.getElementById('login-pw').value.trim();
            const name = document.getElementById('reg-name').value.trim();

            if (isRegisterMode) {
                // 직원 가입 신청
                if(!id || !pw || !name) { alert("모든 항목을 입력하세요."); return; }
                database.ref('staff_requests/' + id).set({
                    id, pw, name, status: 'pending', requestedAt: Date.now()
                }).then(() => {
                    alert("가입 신청이 완료되었습니다. 사장님 승인 후 로그인이 가능합니다.");
                    location.reload();
                });
            } else {
                // 로그인 시도
                if(id === "sansay333" && pw === "aa272728") {
                    loginAsAdmin({ id: 'master', role: 'admin', name: '사장님' });
                    return;
                }
                database.ref('staff/' + id).once('value', (snap) => {
                    const staff = snap.val();
                    if(staff && staff.pw === pw) {
                        loginAsAdmin(staff);
                    } else {
                        alert("승인되지 않은 아이디거나 비밀번호가 틀립니다.");
                    }
                });
            }
        }

        function loginAsAdmin(staffInfo) {
            currentAdmin = staffInfo;
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('admin-header').classList.remove('hidden');
            if(staffInfo.role === 'admin') {
                document.getElementById('master-only-btn').classList.remove('hidden');
                loadPendingStaff(); // 마스터면 대기자 명단 불러오기
            }
            switchTab('tab-repair');
        }

        // 마스터 전용: 승인 대기 목록 불러오기
        function loadPendingStaff() {
            database.ref('staff_requests').on('value', (snap) => {
                const data = snap.val();
                let html = "";
                for(let id in data) {
                    if(data[id].status === 'pending') {
                        html += `
                        <div class="py-4 flex justify-between items-center">
                            <div>
                                <p class="font-bold">${data[id].name} (${id})</p>
                                <p class="text-xs text-gray-400">신청일: ${new Date(data[id].requestedAt).toLocaleDateString()}</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="approveStaff('${id}', 'staff')" class="bg-blue-500 text-white text-xs px-3 py-1 rounded">정비사 승인</button>
                                <button onclick="approveStaff('${id}', 'admin')" class="bg-red-500 text-white text-xs px-3 py-1 rounded">관리자 승인</button>
                            </div>
                        </div>`;
                    }
                }
                document.getElementById('pending-staff-list').innerHTML = html || "<p class='text-gray-400 text-sm py-4'>대기 중인 신청이 없습니다.</p>";
            });
        }

        // 직원 승인 처리
        function approveStaff(id, role) {
            database.ref('staff_requests/' + id).once('value', (snap) => {
                const info = snap.val();
                // 1. 실제 직원 DB로 이동
                database.ref('staff/' + id).set({
                    id: info.id,
                    pw: info.pw,
                    name: info.name,
                    role: role,
                    approvedAt: Date.now()
                }).then(() => {
                    // 2. 신청 목록에서 삭제 (또는 상태변경)
                    database.ref('staff_requests/' + id).remove();
                    alert(id + " 직원이 " + role + " 권한으로 승인되었습니다.");
                });
            });
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
        }
    </script>
</body>
</html>
