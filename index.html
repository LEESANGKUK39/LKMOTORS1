<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LKMOTORS ERP - í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f1f5f9; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .hidden { display: none !important; }
        input { border: 1px solid #e2e8f0; padding: 10px; border-radius: 10px; outline: none; }
        input:focus { border-color: #3b82f6; ring: 2px ring #3b82f6; }
        .logo-link { cursor: pointer; transition: 0.3s; }
        .logo-link:hover { opacity: 0.7; }
    </style>
</head>
<body>

    <header id="admin-header" class="hidden bg-slate-900 text-white p-4 shadow-xl sticky top-0 z-50">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <h1 onclick="switchTab('tab-repair')" class="logo-link font-black italic text-2xl text-blue-400">LKMOTORS ERP</h1>
            <div class="flex gap-2 text-sm font-bold overflow-x-auto">
                <button onclick="switchTab('tab-repair')" class="px-3 py-2 hover:bg-slate-800 rounded-lg">ì •ë¹„/ê²€ìƒ‰</button>
                <button onclick="switchTab('tab-booking')" class="px-3 py-2 hover:bg-slate-800 rounded-lg">ì˜ˆì•½í˜„í™©</button>
                <button onclick="switchTab('tab-stock')" class="px-3 py-2 hover:bg-slate-800 rounded-lg text-green-400">ë¶€í’ˆì¬ê³ </button>
                <button id="master-only-btn" onclick="switchTab('tab-staff')" class="hidden px-3 py-2 text-red-400 hover:bg-slate-800 rounded-lg">ì§ì›ìŠ¹ì¸</button>
                <button onclick="location.reload()" class="bg-red-600 px-3 py-2 rounded-lg ml-2">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-4">
        <section id="login-section" class="max-w-md mx-auto bg-white p-8 rounded-3xl shadow-2xl mt-12 text-center">
            <div class="text-5xl mb-4">ğŸ”</div>
            <h2 id="login-title" class="text-2xl font-black mb-6 italic text-slate-800">STAFF ACCESS</h2>
            <div class="flex flex-col gap-4">
                <input type="text" id="login-id" placeholder="ì•„ì´ë”” (ë˜ëŠ” ì°¨ëŸ‰ë²ˆí˜¸)">
                <input type="password" id="login-pw" placeholder="ë¹„ë°€ë²ˆí˜¸">
                <div id="reg-extra-fields" class="hidden"><input type="text" id="reg-name" placeholder="ì„±í•¨" class="w-full bg-blue-50"></div>
                <button id="main-btn" onclick="handleMainLogin()" class="w-full py-4 bg-slate-900 text-white font-bold rounded-2xl">ë¡œê·¸ì¸</button>
                <button id="switch-btn" onclick="toggleRegisterMode()" class="text-blue-500 text-sm font-bold">ì‹ ê·œ ì§ì› ê°€ì… ì‹ ì²­</button>
            </div>
        </section>

        <section id="tab-repair" class="tab-content space-y-4 mt-4">
            <div class="bg-white p-6 rounded-3xl shadow-md border-b-4 border-blue-500">
                <div class="flex gap-2">
                    <input type="text" id="search-car" placeholder="ì°¨ëŸ‰ë²ˆí˜¸ ê²€ìƒ‰" class="flex-1 uppercase font-bold text-xl">
                    <button onclick="searchCarAdmin()" class="px-8 bg-blue-600 text-white rounded-xl font-bold">ì¡°íšŒ</button>
                </div>
            </div>

            <div id="repair-admin-area" class="hidden space-y-4">
                <div class="bg-white p-6 rounded-3xl shadow-md">
                    <h3 class="font-black text-2xl mb-6 text-slate-800" id="target-car-num"></h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
                        <input type="date" id="r-date" class="font-bold">
                        <input type="text" id="r-staff" placeholder="ì •ë¹„ì‚¬ ì„±í•¨">
                    </div>

                    <div class="space-y-2 border-t pt-4">
                        <div class="grid grid-cols-12 gap-2 text-xs font-bold text-slate-400 px-2 text-center">
                            <div class="col-span-4">í’ˆë²ˆ ë˜ëŠ” ë¶€í’ˆëª…</div>
                            <div class="col-span-2">ìˆ˜ëŸ‰</div>
                            <div class="col-span-3">ë¶€í’ˆë¹„(ë‹¨ê°€)</div>
                            <div class="col-span-2">ê³µì„</div>
                        </div>
                        <div id="repair-items-container" class="space-y-2"></div>
                        <button onclick="addRow()" class="w-full py-2 border-2 border-dashed border-slate-300 rounded-xl text-slate-400 font-bold">+ í•­ëª© ì¶”ê°€</button>
                    </div>

                    <div class="mt-6 p-4 bg-blue-50 rounded-2xl flex justify-between items-center">
                        <span class="font-bold text-blue-800">ì˜ˆìƒ ê²°ì œ ê¸ˆì•¡</span>
                        <span id="total-display" class="font-black text-2xl text-blue-600">â‚© 0</span>
                    </div>
                    <button onclick="saveDetailedRepair()" class="w-full py-5 bg-slate-900 text-white rounded-2xl font-black text-lg mt-4 shadow-xl">ì •ë¹„ ê¸°ë¡ ë° ì¬ê³  ì°¨ê° ì €ì¥</button>
                </div>
                <div id="repair-history-list" class="space-y-3 mt-8"></div>
            </div>
        </section>

        <section id="tab-booking" class="tab-content space-y-4 mt-4">
            <div class="bg-white p-6 rounded-3xl shadow-md">
                <h3 class="text-xl font-black mb-4 flex items-center gap-2"><span class="w-2 h-6 bg-blue-500 rounded-full"></span>ì‹ ê·œ ì˜ˆì•½ (ì‹œê°„ í¬í•¨)</h3>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                    <input type="date" id="book-date">
                    <input type="time" id="book-time">
                    <input type="text" id="book-car" placeholder="ì°¨ëŸ‰ë²ˆí˜¸" class="uppercase">
                    <input type="text" id="book-desc" placeholder="ì •ë¹„ ë‚´ìš©">
                    <button onclick="saveBooking()" class="bg-blue-600 text-white rounded-xl font-bold">ì˜ˆì•½ í™•ì •</button>
                </div>
            </div>
            <div id="booking-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </section>

        <section id="tab-stock" class="tab-content space-y-4 mt-4 text-left">
            <div class="bg-white p-6 rounded-3xl shadow-md border-b-4 border-green-500">
                <h3 class="text-xl font-black mb-4 text-green-600 italic text-center">STOCK MANAGEMENT</h3>
                <div class="grid grid-cols-2 md:grid-cols-6 gap-3">
                    <input type="text" id="stock-pn" placeholder="í’ˆë²ˆ(PN)" class="font-bold border-green-200">
                    <input type="text" id="stock-name" placeholder="ë¶€í’ˆëª…">
                    <input type="number" id="stock-in-price" placeholder="ì…ê³ ê°€">
                    <input type="number" id="stock-out-price" placeholder="ì¶œê³ ê°€">
                    <input type="number" id="stock-count" placeholder="ì´ˆê¸°ì¬ê³ ">
                    <button onclick="saveStock()" class="bg-green-600 text-white rounded-xl font-bold">ì¬ê³  ë“±ë¡</button>
                </div>
            </div>
            <div class="bg-white rounded-3xl shadow-md overflow-hidden border">
                <table class="w-full text-sm">
                    <thead class="bg-slate-50 border-b">
                        <tr><th class="p-4">í’ˆë²ˆ</th><th class="p-4">ë¶€í’ˆëª…</th><th class="p-4">í˜„ì¬ê³ </th><th class="p-4">ì…ê³ ê°€</th><th class="p-4">ì •ë¹„ë‹¨ê°€</th></tr>
                    </thead>
                    <tbody id="stock-table-body" class="divide-y text-center"></tbody>
                </table>
            </div>
        </section>

        <section id="tab-staff" class="tab-content mt-4">
            <div class="bg-white p-6 rounded-3xl shadow-md border-t-8 border-red-500">
                <h3 class="text-xl font-black mb-4 text-red-600 italic">STAFF APPROVAL</h3>
                <div id="pending-staff-list" class="divide-y"></div>
            </div>
        </section>
    </main>

    <script>
        // 1. íŒŒì´ì–´ë² ì´ìŠ¤ ì„¤ì • (ë°˜ë“œì‹œ ë³¸ì¸ ê²ƒìœ¼ë¡œ êµì²´!)
        const firebaseConfig = {
            apiKey: "AIzaSyDhTPGNKNm38PSBdATs9lks0lYu52QrP3A",
            authDomain: "lkmotors-246f1.firebaseapp.com",
            databaseURL: "https://lkmotors-246f1-default-rtdb.firebaseio.com",
            projectId: "lkmotors-246f1",
            storageBucket: "lkmotors-246f1.firebasestorage.app",
            messagingSenderId: "389443224",
            appId: "1:389443224:web:c9b78c1afd3abc1c262aed"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let isRegisterMode = false;
        let currentAdmin = null;
        let searchTargetCar = "";

        // ë¡œê·¸ì¸ í•¸ë“¤ëŸ¬
        function handleMainLogin() {
            const id = document.getElementById('login-id').value.trim();
            const pw = document.getElementById('login-pw').value.trim();
            if(id === "sansay333" && pw === "aa272728") {
                loginAsAdmin({ id: 'master', role: 'admin', name: 'ì‚¬ì¥ë‹˜' });
                return;
            }
            database.ref('staff/' + id).once('value', (snap) => {
                const staff = snap.val();
                if(staff && staff.pw === pw) { loginAsAdmin(staff); }
                else { alert("ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì´ê±°ë‚˜ ì˜ëª»ëœ ì •ë³´ì…ë‹ˆë‹¤."); }
            });
        }

        function loginAsAdmin(staff) {
            currentAdmin = staff;
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('admin-header').classList.remove('hidden');
            if(staff.role === 'admin') document.getElementById('master-only-btn').classList.remove('hidden');
            switchTab('tab-repair');
        }

        function toggleRegisterMode() {
            isRegisterMode = !isRegisterMode;
            document.getElementById('reg-extra-fields').classList.toggle('hidden');
            document.getElementById('main-btn').innerText = isRegisterMode ? "ê°€ì… ì‹ ì²­" : "ë¡œê·¸ì¸";
        }

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'tab-booking') loadBookings();
            if(id === 'tab-stock') loadStocks();
        }

        // ì •ë¹„ í•­ëª© ì¶”ê°€ (ìˆ˜ëŸ‰ í¬í•¨)
        function addRow() {
            const container = document.getElementById('repair-items-container');
            const div = document.createElement('div');
            div.className = "item-row grid grid-cols-12 gap-2 mb-2";
            div.innerHTML = `
                <input type="text" placeholder="í’ˆë²ˆ/ë¶€í’ˆëª…" class="col-span-4 item-key text-sm">
                <input type="number" value="1" class="col-span-2 item-qty text-sm text-center" oninput="calcTotal()">
                <input type="number" placeholder="ë¶€í’ˆë¹„" class="col-span-3 item-part text-sm text-right" oninput="calcTotal()">
                <input type="number" placeholder="ê³µì„" class="col-span-2 item-labor text-sm text-right" oninput="calcTotal()">
                <button onclick="this.parentElement.remove(); calcTotal();" class="col-span-1 text-red-500 font-bold">X</button>
            `;
            container.appendChild(div);
        }

        function calcTotal() {
            let total = 0;
            document.querySelectorAll('.item-row').forEach(row => {
                const q = parseInt(row.querySelector('.item-qty').value) || 0;
                const p = parseInt(row.querySelector('.item-part').value) || 0;
                const l = parseInt(row.querySelector('.item-labor').value) || 0;
                total += (q * p) + l;
            });
            document.getElementById('total-display').innerText = "â‚© " + total.toLocaleString();
            return total;
        }

        // ì •ë¹„ ê¸°ë¡ ë° ì¬ê³  ì°¨ê° ë¡œì§
        async function saveDetailedRepair() {
            const date = document.getElementById('r-date').value;
            const staff = document.getElementById('r-staff').value || currentAdmin.name;
            const items = [];
            const rows = document.querySelectorAll('.item-row');

            for (let row of rows) {
                const key = row.querySelector('.item-key').value.trim();
                const qty = parseInt(row.querySelector('.item-qty').value) || 0;
                const part = parseInt(row.querySelector('.item-part').value) || 0;
                const labor = parseInt(row.querySelector('.item-labor').value) || 0;

                if(key) {
                    items.push({ name: key, quantity: qty, partPrice: part, laborPrice: labor });
                    await deductStock(key, qty); // ì¬ê³  ì°¨ê° í•¨ìˆ˜ í˜¸ì¶œ
                }
            }

            database.ref('repairs/' + searchTargetCar).push({
                date, staff, items, total: calcTotal(), createdAt: Date.now()
            }).then(() => {
                alert("ì •ë¹„ ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ (ì¬ê³  ìë™ ì°¨ê° ì™„ë£Œ)");
                loadRepairHistory(searchTargetCar);
            });
        }

        // ì§€ëŠ¥í˜• ì¬ê³  ì°¨ê° (PN ìš°ì„  -> ì´ë¦„ ë§¤ì¹­)
        async function deductStock(key, qty) {
            const snap = await database.ref('stocks').once('value');
            const stocks = snap.val();
            if(!stocks) return;

            for(let pn in stocks) {
                if(pn === key || stocks[pn].name === key) {
                    const newCount = (parseInt(stocks[pn].count) || 0) - qty;
                    await database.ref('stocks/' + pn).update({ count: newCount });
                    break;
                }
            }
        }

        function saveStock() {
            const pn = document.getElementById('stock-pn').value.trim();
            const name = document.getElementById('stock-name').value.trim();
            const count = parseInt(document.getElementById('stock-count').value) || 0;
            if(!pn || !name) return;
            database.ref('stocks/' + pn).set({
                pn, name, count,
                inPrice: document.getElementById('stock-in-price').value,
                outPrice: document.getElementById('stock-out-price').value
            }).then(() => { alert("ë¶€í’ˆ ë“±ë¡ ì™„ë£Œ!"); loadStocks(); });
        }

        function loadStocks() {
            database.ref('stocks').once('value', snap => {
                const data = snap.val();
                let html = "";
                for(let k in data) {
                    html += `<tr><td class="p-3">${data[k].pn}</td><td class="p-3 font-bold">${data[k].name}</td><td class="p-3 font-black text-blue-600">${data[k].count}</td><td class="p-3">â‚©${data[k].inPrice}</td><td class="p-3 text-red-500">â‚©${data[k].outPrice}</td></tr>`;
                }
                document.getElementById('stock-table-body').innerHTML = html;
            });
        }

        function searchCarAdmin() {
            searchTargetCar = document.getElementById('search-car').value.toUpperCase().trim();
            if(!searchTargetCar) return;
            document.getElementById('repair-admin-area').classList.remove('hidden');
            document.getElementById('target-car-num').innerText = searchTargetCar + " ì •ë¹„ ê´€ë¦¬";
            document.getElementById('repair-items-container').innerHTML = '';
            addRow();
            loadRepairHistory(searchTargetCar);
        }

        function loadRepairHistory(car) {
            database.ref('repairs/' + car).once('value', snap => {
                const data = snap.val();
                let html = "";
                if(data) {
                    Object.values(data).reverse().forEach(r => {
                        html += `<div class="p-4 bg-white rounded-2xl shadow-sm border border-slate-200">
                            <p class="text-[10px] text-slate-400 font-bold">${r.date} | ë‹´ë‹¹: ${r.staff}</p>
                            <div class="mt-2 space-y-1">
                                ${r.items.map(i => `<p class="text-sm"><b>${i.name}</b> x ${i.quantity}ê°œ <span class="text-slate-400 text-xs">(ê³µì„í¬í•¨ â‚©${((i.partPrice*i.quantity)+i.laborPrice).toLocaleString()})</span></p>`).join('')}
                            </div>
                            <p class="text-right font-black text-blue-600 mt-2 border-t pt-2">í•©ê³„: â‚© ${r.total.toLocaleString()}</p>
                        </div>`;
                    });
                }
                document.getElementById('repair-history-list').innerHTML = html || "<p class='text-center text-slate-400 py-8'>ì •ë¹„ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
            });
        }

        function saveBooking() {
            const date = document.getElementById('book-date').value;
            const time = document.getElementById('book-time').value;
            const car = document.getElementById('book-car').value.toUpperCase();
            if(!date || !car) return;
            database.ref('bookings').push({ date, time, car, desc: document.getElementById('book-desc').value, status: 'ëŒ€ê¸°' })
            .then(() => { alert("ì˜ˆì•½ ì €ì¥!"); loadBookings(); });
        }

        function loadBookings() {
            database.ref('bookings').once('value', snap => {
                const data = snap.val();
                let html = "";
                for(let k in data) {
                    html += `<div class="p-4 bg-white rounded-2xl shadow-sm border-l-4 border-blue-500">
                        <p class="font-black text-lg text-slate-800">${data[k].car}</p>
                        <p class="text-sm text-slate-500 font-bold">${data[k].date} ${data[k].time}</p>
                        <p class="text-sm mt-1 text-slate-600">${data[k].desc}</p>
                    </div>`;
                }
                document.getElementById('booking-list').innerHTML = html || "<p class='col-span-2 text-center py-8 text-slate-400'>í™•ì •ëœ ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
            });
        }
    </script>
</body>
</html>
