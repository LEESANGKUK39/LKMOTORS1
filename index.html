<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LKMOTORS ERP - V3</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background: #f1f5f9; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* [명세서 규격 최적화] */
        .bill-container { 
            background: white; padding: 20px; border: 1px solid #000; 
            width: 210mm; height: 285mm; margin: 0 auto; overflow: hidden;
            display: flex; flex-direction: column;
        }
        .t-frame { width: 100%; border-collapse: collapse; border: 2px solid #000; margin-bottom: 5px; }
        .t-frame td, .t-frame th { border: 1px solid #000; padding: 5px; font-size: 12px; }
        .bg-gray { background: #f8fafc; font-weight: 900; width: 14%; text-align: center; }
        .input-full { border: none; width: 100%; outline: none; background: transparent; }
        
        /* 캘린더 */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); border: 1px solid #ddd; }
        .calendar-day { min-height: 80px; border: 1px solid #eee; padding: 4px; font-size: 12px; cursor: pointer; }
        .event-dot { font-size: 10px; background: #2563eb; color: white; padding: 1px 3px; border-radius: 3px; margin-top: 2px; white-space: nowrap; overflow: hidden; }

        @media print { 
            .no-print { display: none !important; } 
            body { background: white; padding: 0; }
            .bill-container { border: none; margin: 0; padding: 0; width: 210mm; } 
        }
    </style>
</head>
<body>

    <div id="auth-layer" class="fixed inset-0 bg-slate-900 flex items-center justify-center z-[100]">
        <div class="bg-white p-8 rounded-[30px] shadow-2xl w-full max-w-md">
            <h2 class="text-3xl font-black italic text-center mb-6">LKMOTORS</h2>
            <div id="login-form" class="space-y-3">
                <input type="text" id="uid" placeholder="아이디" class="w-full p-3 border rounded-xl font-bold">
                <input type="password" id="upw" placeholder="비밀번호" class="w-full p-3 border rounded-xl font-bold">
                <button onclick="login()" class="w-full py-4 bg-blue-600 text-white font-black rounded-xl">로그인</button>
                <button onclick="toggleAuth(true)" class="w-full text-sm text-slate-400 underline">회원가입 신청</button>
            </div>
            <div id="signup-form" class="hidden space-y-3">
                <select id="reg-type" class="w-full p-3 border rounded-xl font-bold">
                    <option value="customer">고객(차주) 가입</option>
                    <option value="staff">직원 가입</option>
                </select>
                <input type="text" id="rid" placeholder="아이디" class="w-full p-3 border rounded-xl">
                <input type="password" id="rpw" placeholder="비밀번호" class="w-full p-3 border rounded-xl">
                <input type="text" id="rname" placeholder="성함/상호" class="w-full p-3 border rounded-xl">
                <input type="text" id="rcar" placeholder="차량번호(고객)" class="w-full p-3 border rounded-xl uppercase">
                <button onclick="register()" class="w-full py-4 bg-slate-800 text-white font-black rounded-xl">가입 승인 요청</button>
                <button onclick="toggleAuth(false)" class="w-full text-sm text-slate-400">뒤로가기</button>
            </div>
        </div>
    </div>

    <div id="main-layer" class="hidden">
        <header class="no-print bg-slate-900 text-white p-4 sticky top-0 z-50">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <h1 class="font-black italic text-xl" onclick="showT('t-repair')">LKMOTORS</h1>
                <nav id="nav-menu" class="flex gap-4 font-bold text-xs"></nav>
            </div>
        </header>

        <main class="max-w-6xl mx-auto p-4">
            <section id="t-repair" class="tab-content active">
                <div class="no-print flex gap-2 mb-4">
                    <input type="text" id="car-search" placeholder="차량번호 검색" class="flex-1 p-2 border rounded-xl font-bold uppercase">
                    <button onclick="findCar()" class="px-6 bg-blue-600 text-white font-bold rounded-xl text-sm">검색</button>
                </div>

                <div class="bill-container">
                    <h2 class="text-3xl font-black text-center mb-4 underline italic">SERVICE INVOICE</h2>
                    
                    <table class="t-frame">
                        <tr>
                            <td class="bg-gray">차량번호</td><td><input type="text" id="v-car" class="input-full font-bold uppercase"></td>
                            <td class="bg-gray">차주성함</td><td><input type="text" id="v-owner" class="input-full font-bold"></td>
                        </tr>
                        <tr>
                            <td class="bg-gray">차량형식</td><td><input type="text" id="v-type" class="input-full"></td>
                            <td class="bg-gray">차대번호</td><td><input type="text" id="v-vin" class="input-full text-[10px] uppercase font-mono"></td>
                        </tr>
                    </table>

                    <table class="t-frame">
                        <tr class="text-center font-bold">
                            <td class="bg-gray">입고 날짜</td><td><input type="date" id="v-date-in" class="input-full text-center"></td>
                            <td class="bg-gray">완료 날짜</td><td><input type="date" id="v-date-done" class="input-full text-center"></td>
                            <td class="bg-gray">출고 날짜</td><td><input type="date" id="v-date-out" class="input-full text-center"></td>
                        </tr>
                    </table>

                    <table class="t-frame">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="p-2">정비내역 및 부품명</th>
                                <th class="w-32">부품번호 (P/N)</th>
                                <th class="w-12">수량</th>
                                <th class="w-24">단가</th>
                                <th class="w-24">공임</th>
                                <th class="w-28">공급가액</th>
                            </tr>
                        </thead>
                        <tbody id="bill-items"></tbody>
                    </table>

                    <div class="flex justify-end mt-1">
                        <table class="w-64 border-2 border-black font-bold">
                            <tr><td class="bg-gray p-1 text-xs">공급가액</td><td class="text-right p-1" id="sum-net">0</td></tr>
                            <tr><td class="bg-gray p-1 text-xs">부가세(10%)</td><td class="text-right p-1" id="sum-vat">0</td></tr>
                            <tr class="text-blue-700 bg-blue-50"><td class="p-1">합 계</td><td class="text-right p-1" id="sum-total">0</td></tr>
                        </table>
                    </div>

                    <div class="mt-auto pt-4 border-t border-black flex justify-between items-end">
                        <span class="text-[10px] font-bold italic">LKMOTORS AUTO SERVICE</span>
                        <div class="font-black text-lg">발행일자: <input type="date" id="v-bill-date" class="border-b border-black w-36 text-center"></div>
                    </div>
                </div>

                <div class="no-print mt-4 flex gap-2">
                    <button onclick="saveInvoice()" class="flex-1 py-4 bg-slate-900 text-white font-bold rounded-xl">기록 저장</button>
                    <button onclick="window.print()" class="px-8 bg-slate-400 text-white font-bold rounded-xl">인쇄</button>
                </div>
            </section>

            <section id="t-book" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <div class="lg:col-span-2 bg-white p-4 rounded-2xl shadow border">
                        <div class="flex justify-between mb-4">
                            <h3 id="cal-month" class="text-xl font-bold italic"></h3>
                            <div class="flex gap-1">
                                <button onclick="changeMonth(-1)" class="p-1 border rounded">◀</button>
                                <button onclick="changeMonth(1)" class="p-1 border rounded">▶</button>
                            </div>
                        </div>
                        <div id="cal-body" class="calendar-grid"></div>
                        
                        <div class="mt-6">
                            <h4 class="font-black text-blue-600 mb-2">▼ 전체 예약 현황</h4>
                            <div id="book-list-view" class="space-y-2 max-h-60 overflow-y-auto"></div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-2xl shadow border h-fit">
                        <h3 class="font-black mb-4">정비 예약 등록/수정</h3>
                        <input type="hidden" id="edit-book-key">
                        <div class="space-y-3">
                            <input type="date" id="book-date" class="w-full border-b p-2 font-bold">
                            <div class="flex gap-2">
                                <select id="book-hour" class="flex-1 border-b p-2"></select>
                                <select id="book-min" class="flex-1 border-b p-2"></select>
                            </div>
                            <input type="text" id="book-car" placeholder="차량번호" class="w-full border-b p-2 uppercase font-bold">
                            <textarea id="book-desc" class="w-full h-24 border rounded-xl p-2 text-sm" placeholder="상세 내용"></textarea>
                            <div id="book-btn-group" class="flex gap-2">
                                <button onclick="saveBooking()" class="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl">예약 저장</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="t-stock" class="tab-content">
                <div class="bg-white p-4 rounded-xl shadow border mb-4 flex gap-2 flex-wrap">
                    <input type="text" id="s-nm" placeholder="부품명" class="p-2 border rounded-lg font-bold flex-1">
                    <input type="text" id="s-pn" placeholder="품번" class="p-2 border rounded-lg w-32 font-bold">
                    <input type="number" id="s-qt" placeholder="수량" class="p-2 border rounded-lg w-20">
                    <input type="number" id="s-pr" placeholder="단가" class="p-2 border rounded-lg w-24">
                    <button onclick="addStock()" class="px-4 bg-slate-900 text-white font-bold rounded-lg">입고</button>
                </div>
                <div class="bg-white rounded-xl shadow overflow-hidden">
                    <table class="w-full text-center text-sm">
                        <thead class="bg-slate-800 text-white font-bold"><tr><th class="p-3">부품명</th><th>품번</th><th>재고</th><th>단가</th><th>관리</th></tr></thead>
                        <tbody id="s-list" class="divide-y"></tbody>
                    </table>
                </div>
            </section>

            <section id="t-mgr" class="tab-content">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-white p-6 rounded-2xl shadow border">
                        <h3 class="font-black mb-4">고객 승인 대기</h3>
                        <div id="wait-customer" class="space-y-2"></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow border">
                        <h3 class="font-black mb-4">직원 승인 대기</h3>
                        <div id="wait-staff" class="space-y-2"></div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDhTPGNKNm38PSBdATs9lks0lYu52QrP3A",
            authDomain: "lkmotors-246f1.firebaseapp.com",
            databaseURL: "https://lkmotors-246f1-default-rtdb.firebaseio.com",
            projectId: "lkmotors-246f1",
            storageBucket: "lkmotors-246f1.firebasestorage.app",
            messagingSenderId: "389443224",
            appId: "1:389443224:web:c9b78c1afd3abc1c262aed"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let curUser = null;
        let viewDate = new Date();

        function toggleAuth(s) {
            document.getElementById('login-form').classList.toggle('hidden', s);
            document.getElementById('signup-form').classList.toggle('hidden', !s);
        }

        function register() {
            const id = document.getElementById('rid').value;
            const pw = document.getElementById('rpw').value;
            const nm = document.getElementById('rname').value;
            const type = document.getElementById('reg-type').value;
            const car = document.getElementById('rcar').value.toUpperCase();
            if(!id || !pw) return alert("필수항목 입력");
            db.ref('users/' + id).set({ id, pw, nm, type, car, approved: false })
            .then(() => { alert("가입 신청 완료!"); toggleAuth(false); });
        }

        function login() {
            const id = document.getElementById('uid').value, pw = document.getElementById('upw').value;
            if(id === "sansay333" && pw === "aa272728") { enterSystem({type:'admin', nm:'사장님', id:'admin'}); return; }
            db.ref('users/'+id).once('value', snap => {
                const u = snap.val();
                if(u && u.pw === pw) {
                    if(u.approved) enterSystem(u);
                    else alert("승인 대기 중입니다.");
                } else alert("정보가 틀립니다.");
            });
        }

        function enterSystem(u) {
            curUser = u;
            document.getElementById('auth-layer').classList.add('hidden');
            document.getElementById('main-layer').classList.remove('hidden');
            const nav = document.getElementById('nav-menu');
            if(u.type === 'admin') {
                nav.innerHTML = `<button onclick="showT('t-repair')">정비</button><button onclick="showT('t-book')">예약</button><button onclick="showT('t-stock')">재고</button><button onclick="showT('t-mgr')">승인</button>`;
                loadWaiters();
            } else {
                nav.innerHTML = `<button onclick="showT('t-repair')">정비이력</button><button onclick="showT('t-book')">정비예약</button>`;
            }
            initRows(); initTimeSelect();
        }

        // [정비 내역 및 계산]
        function initRows() {
            const b = document.getElementById('bill-items'); b.innerHTML = "";
            for(let i=0; i<15; i++) {
                b.innerHTML += `<tr class="r-row">
                    <td><input type="text" class="i-nm input-full font-bold"></td>
                    <td><input type="text" class="i-pn input-full text-center text-[10px]"></td>
                    <td><input type="number" class="i-qt input-full text-center" value="0" oninput="calc()"></td>
                    <td><input type="number" class="i-pr input-full text-right" value="0" oninput="calc()"></td>
                    <td><input type="number" class="i-lb input-full text-right" value="0" oninput="calc()"></td>
                    <td class="i-sum text-right font-black px-2 bg-slate-50">0</td>
                </tr>`;
            }
        }

        function calc() {
            let net = 0;
            document.querySelectorAll('.r-row').forEach(r => {
                const q = parseFloat(r.querySelector('.i-qt').value) || 0;
                const p = parseFloat(r.querySelector('.i-pr').value) || 0;
                const l = parseFloat(r.querySelector('.i-lb').value) || 0;
                const s = (q * p) + l;
                r.querySelector('.i-sum').innerText = s.toLocaleString();
                net += s;
            });
            const vat = Math.floor(net * 0.1);
            document.getElementById('sum-net').innerText = net.toLocaleString();
            document.getElementById('sum-vat').innerText = vat.toLocaleString();
            document.getElementById('sum-total').innerText = "₩ " + (net+vat).toLocaleString();
        }

        // [예약 관리 - 10분 단위 / 수정·삭제·리스트]
        function initTimeSelect() {
            const h = document.getElementById('book-hour'), m = document.getElementById('book-min');
            h.innerHTML = ""; m.innerHTML = "";
            for(let i=8; i<=20; i++) h.innerHTML += `<option value="${String(i).padStart(2,'0')}">${i}시</option>`;
            for(let i=0; i<60; i+=10) m.innerHTML += `<option value="${String(i).padStart(2,'0')}">${i}분</option>`;
        }

        function saveBooking() {
            const key = document.getElementById('edit-book-key').value;
            const date = document.getElementById('book-date').value;
            const time = `${document.getElementById('book-hour').value}:${document.getElementById('book-min').value}`;
            const car = document.getElementById('book-car').value.toUpperCase();
            const desc = document.getElementById('book-desc').value;
            if(!date || !car) return alert("날짜/차번호 필수");

            const data = { date, time, car, desc };
            if(key) db.ref('books/'+key).update(data).then(() => resetBook());
            else db.ref('books').push(data).then(() => resetBook());
        }

        function editBook(k) {
            db.ref('books/'+k).once('value', s => {
                const b = s.val();
                document.getElementById('edit-book-key').value = k;
                document.getElementById('book-date').value = b.date;
                document.getElementById('book-hour').value = b.time.split(':')[0];
                document.getElementById('book-min').value = b.time.split(':')[1];
                document.getElementById('book-car').value = b.car;
                document.getElementById('book-desc').value = b.desc;
                document.getElementById('book-btn-group').innerHTML = `
                    <button onclick="saveBooking()" class="flex-1 py-3 bg-green-600 text-white font-bold rounded-xl text-xs">수정</button>
                    <button onclick="deleteBook('${k}')" class="flex-1 py-3 bg-red-600 text-white font-bold rounded-xl text-xs">삭제</button>
                    <button onclick="resetBook()" class="px-3 bg-slate-200 rounded-xl font-bold">X</button>`;
            });
        }

        function deleteBook(k) { if(confirm("삭제할까요?")) db.ref('books/'+k).remove().then(()=>resetBook()); }
        function resetBook() { 
            document.getElementById('edit-book-key').value = "";
            document.getElementById('book-car').value = "";
            document.getElementById('book-desc').value = "";
            document.getElementById('book-btn-group').innerHTML = `<button onclick="saveBooking()" class="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl">예약 저장</button>`;
            renderCalendar(); 
        }

        function renderCalendar() {
            const y = viewDate.getFullYear(), m = viewDate.getMonth();
            document.getElementById('cal-month').innerText = `${y}년 ${m+1}월`;
            const first = new Date(y,m,1).getDay(), last = new Date(y,m+1,0).getDate();
            const body = document.getElementById('cal-body'); body.innerHTML = "";
            const listView = document.getElementById('book-list-view'); listView.innerHTML = "";
            
            for(let i=0; i<first; i++) body.innerHTML += `<div class="calendar-day bg-slate-50"></div>`;
            for(let d=1; d<=last; d++) {
                const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const dayDiv = document.createElement('div'); dayDiv.className="calendar-day";
                dayDiv.innerHTML = `<b>${d}</b><div id="ev-${ds}"></div>`;
                dayDiv.onclick = () => document.getElementById('book-date').value = ds;
                body.appendChild(dayDiv);

                db.ref('books').orderByChild('date').equalTo(ds).on('value', s => {
                    const box = document.getElementById('ev-'+ds); if(!box) return; box.innerHTML = "";
                    const vals = s.val(); for(let k in vals) {
                        const dot = document.createElement('div'); dot.className="event-dot";
                        dot.innerText = `${vals[k].time} ${vals[k].car}`;
                        dot.onclick = (e) => { e.stopPropagation(); editBook(k); };
                        box.appendChild(dot);
                        
                        // [리스트 뷰에 추가]
                        const li = `<div onclick="editBook('${k}')" class="p-2 bg-white border-l-4 border-blue-500 shadow-sm text-xs cursor-pointer hover:bg-slate-50">
                            <b>[${vals[k].date} ${vals[k].time}]</b> ${vals[k].car} - ${vals[k].desc || '상세없음'}
                        </div>`;
                        listView.innerHTML += li;
                    }
                });
            }
        }

        // [승인 관리 로직]
        function loadWaiters() {
            db.ref('users').on('value', snap => {
                const us = snap.val(); let cH = "", sH = "";
                for(let k in us) {
                    if(!us[k].approved) {
                        const row = `<div class="flex justify-between items-center p-3 bg-slate-50 rounded-xl border">
                            <div class="text-sm"><b>${us[k].nm}</b> (${us[k].id})<br><span class="text-xs text-blue-500">${us[k].car || '직원'}</span></div>
                            <button onclick="db.ref('users/${us[k].id}').update({approved:true})" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-xs">승인</button>
                        </div>`;
                        if(us[k].type === 'customer') cH += row; else sH += row;
                    }
                }
                document.getElementById('wait-customer').innerHTML = cH || "대기 없음";
                document.getElementById('wait-staff').innerHTML = sH || "대기 없음";
            });
        }

        // [공통 유틸]
        function showT(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 't-book') renderCalendar();
            if(id === 't-stock') loadStock();
        }
        function changeMonth(v) { viewDate.setMonth(viewDate.getMonth()+v); renderCalendar(); }
        
        // (나머지 저장/재고 함수는 이전과 동일)
    </script>
</body>
</html>
