<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LKMOTORS ERP - PRO MASTER</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background: #020617; color: #f8fafc; margin: 0; }
        .top-nav { position: fixed; top: 0; left: 0; right: 0; z-index: 100; background: #1e293b; border-bottom: 2px solid #3b82f6; display: none; height: 60px; overflow-x: auto; }
        .nav-btn { padding: 0 15px; height: 100%; font-weight: 700; color: #94a3b8; border-left: 1px solid #334155; font-size: 0.85rem; white-space: nowrap; }
        .nav-btn.active { background: #3b82f6; color: white; }
        .tab-content { display: none; padding-top: 70px; min-height: 100vh; }
        .tab-content.active { display: block; }

        /* 캘린더 디자인 */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #334155; border: 1px solid #334155; }
        .cal-day { background: #1e293b; min-height: 100px; padding: 5px; cursor: pointer; transition: 0.2s; }
        .cal-day:hover { background: #2d3748; }
        .cal-day.today { border: 2px solid #3b82f6; }
        .cal-num { font-weight: 900; font-size: 1.1rem; }
        .cal-count { font-size: 0.75rem; color: #10b981; font-weight: bold; margin-top: 5px; }

        /* 명세서 스타일 */
        .bill-paper { background: white; color: black; padding: 25px; width: 100%; max-width: 900px; margin: 0 auto; border: 2px solid #000; }
        .t-frame { width: 100%; border-collapse: collapse; border: 1px solid #000; table-layout: fixed; }
        .t-frame td { border: 1px solid #000; padding: 6px; font-size: 12px; }
        .input-bill { border: none; width: 100%; outline: none; font-weight: bold; font-size: 14px; background: transparent; }
        .bg-gray { background: #f1f5f9; font-weight: 800; text-align: center; }

        @media print { .no-print { display: none; } .bill-paper { border: none; padding: 0; } }
    </style>
</head>
<body>

    <div id="auth-layer" class="fixed inset-0 z-[200] flex items-center justify-center bg-slate-950 p-4">
        <div class="bg-slate-900 p-8 rounded-[30px] w-full max-w-md border border-white/10 shadow-2xl">
            <h2 class="text-3xl font-black italic text-center mb-6 text-white text-blue-500">LKMOTORS</h2>
            <div id="login-form" class="space-y-4">
                <input type="text" id="uid" placeholder="아이디" class="w-full p-4 rounded-xl bg-slate-800 text-white outline-none">
                <input type="password" id="upw" placeholder="비밀번호" class="w-full p-4 rounded-xl bg-slate-800 text-white outline-none">
                <button onclick="login()" class="w-full py-4 bg-blue-600 rounded-xl font-black text-white">로그인</button>
                <button onclick="toggleAuth('join')" class="w-full text-slate-400 text-sm">회원가입 신청</button>
            </div>
            <div id="join-form" class="hidden space-y-3">
                <select id="j-type" class="w-full p-4 rounded-xl bg-slate-800 text-white outline-none">
                    <option value="staff">직원(정비사)</option>
                    <option value="client">고객(차주)</option>
                </select>
                <input type="text" id="j-id" placeholder="희망 아이디" class="w-full p-4 rounded-xl bg-slate-800 text-white outline-none">
                <input type="password" id="j-pw" placeholder="비밀번호" class="w-full p-4 rounded-xl bg-slate-800 text-white outline-none">
                <input type="text" id="j-nm" placeholder="이름 / 업체명" class="w-full p-4 rounded-xl bg-slate-800 text-white outline-none">
                <input type="text" id="j-tel" placeholder="연락처" class="w-full p-4 rounded-xl bg-slate-800 text-white outline-none">
                <button onclick="join()" class="w-full py-4 bg-emerald-600 rounded-xl font-black text-white">가입 신청하기</button>
                <button onclick="toggleAuth('login')" class="w-full text-slate-400 text-sm">돌아가기</button>
            </div>
        </div>
    </div>

    <nav class="top-nav no-print" id="main-nav">
        <div class="px-5 text-white font-black italic flex items-center">LK<span>MOTORS</span></div>
        <button onclick="showT('t-repair')" class="nav-btn active" id="btn-repair">정비/명세서</button>
        <button onclick="showT('t-book')" class="nav-btn" id="btn-book">예약/캘린더</button>
        <button onclick="showT('t-stock')" class="nav-btn" id="btn-stock">재고관리</button>
        <button onclick="showT('t-admin')" class="nav-btn text-yellow-500 hidden" id="btn-admin">승인관리</button>
        <button onclick="location.reload()" class="nav-btn text-red-400">로그아웃</button>
    </nav>

    <section id="t-repair" class="tab-content">
        <div class="flex flex-wrap gap-4 p-4 max-w-[1700px] mx-auto">
            <div class="w-full lg:w-80 bg-slate-900 p-5 rounded-2xl h-fit no-print">
                <h3 class="text-blue-400 font-black mb-4">차량 정보 관리</h3>
                <input type="text" id="ext-car" class="w-full p-3 bg-slate-800 rounded-xl text-xl font-black mb-2 border border-blue-900" placeholder="차량번호 입력">
                <button onclick="searchVehicle()" class="w-full py-2 bg-blue-600 rounded-xl font-bold mb-4">정보 불러오기</button>
                
                <div class="space-y-2 text-xs">
                    <label>차량형식</label><input id="ext-type" class="w-full p-2 bg-slate-800 rounded mb-2">
                    <label>차대번호</label><input id="ext-vin" class="w-full p-2 bg-slate-800 rounded mb-2">
                    <label>차주명</label><input id="ext-owner" class="w-full p-2 bg-slate-800 rounded mb-2">
                    <label>연락처</label><input id="ext-tel" class="w-full p-2 bg-slate-800 rounded mb-2">
                </div>
                <hr class="border-slate-800 my-4">
                <h4 class="text-emerald-400 font-bold mb-2 text-sm">최근 정비 이력</h4>
                <div id="v-history-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
                
                <button onclick="saveData()" class="w-full py-4 bg-blue-600 rounded-xl font-black mt-6">최종 저장 / 발행</button>
                <button onclick="resetBill()" class="w-full py-2 bg-slate-800 rounded-xl text-xs mt-2">새 작업 시작</button>
            </div>

            <div class="flex-1 min-w-[320px]">
                <div class="bill-paper" id="print-area">
                    <h1 class="text-center text-3xl font-black underline italic mb-6">정 비 명 세 서</h1>
                    <table class="t-frame">
                        <tr>
                            <td class="bg-gray w-20">차량번호</td><td><input id="v-car" class="input-bill text-lg uppercase font-black"></td>
                            <td class="bg-gray w-20">차량형식</td><td><input id="v-type" class="input-bill"></td>
                        </tr>
                        <tr>
                            <td class="bg-gray">차대번호</td><td><input id="v-vin" class="input-bill uppercase font-mono"></td>
                            <td class="bg-gray">주행거리</td><td><input id="v-mile" class="input-bill text-right" placeholder="Km"></td>
                        </tr>
                    </table>
                    <table class="t-frame mt-2 text-center">
                        <tr class="bg-gray font-bold">
                            <td>입고 날짜</td><td>완료 날짜</td><td>출고 날짜</td>
                        </tr>
                        <tr>
                            <td><input type="date" id="v-date-in" class="input-bill text-center"></td>
                            <td><input type="date" id="v-date-done" class="input-bill text-center"></td>
                            <td><input type="date" id="v-date-out" class="input-bill text-center"></td>
                        </tr>
                    </table>
                    <table class="t-frame mt-2">
                        <thead class="bg-gray font-bold">
                            <tr><th class="w-1/3">부품/정비항목</th><th>품번</th><th class="w-12">수량</th><th class="w-20">단가</th><th class="w-20">공임</th><th class="w-24">합계</th></tr>
                        </thead>
                        <tbody id="bill-items"></tbody>
                    </table>
                    <div class="flex justify-between items-center mt-6">
                        <div class="text-[10px] font-bold">차주: <span id="v-owner-name">-</span> / 연락처: <span id="v-owner-tel">-</span></div>
                        <div class="text-right border-4 border-black p-2">
                            <span class="text-xs font-black">합계 (VAT포함): </span>
                            <span class="text-2xl font-black text-blue-700">₩ <span id="grand-total">0</span></span>
                        </div>
                    </div>
                </div>
                <button onclick="window.print()" class="no-print w-full mt-4 py-4 bg-slate-800 rounded-xl font-bold">명세서 인쇄 (Print)</button>
            </div>
        </div>
    </section>

    <section id="t-book" class="tab-content px-4">
        <div class="max-w-6xl mx-auto flex flex-wrap gap-6">
            <div class="flex-1 min-w-[350px]">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="cal-month-title" class="text-2xl font-black">2026년 1월</h3>
                    <div class="flex gap-2">
                        <button onclick="changeMonth(-1)" class="p-2 bg-slate-800 rounded">◀</button>
                        <button onclick="changeMonth(1)" class="p-2 bg-slate-800 rounded">▶</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendar-body"></div>
            </div>
            
            <div class="w-full lg:w-96 bg-slate-900 p-6 rounded-2xl h-fit border border-emerald-500">
                <h3 id="selected-date-title" class="text-emerald-400 font-black mb-4 italic">날짜를 선택하세요</h3>
                <div id="day-booking-list" class="space-y-2 mb-6 max-h-60 overflow-y-auto"></div>
                
                <hr class="border-slate-800 mb-6">
                <h4 class="font-bold mb-4">신규 예약 등록</h4>
                <div class="space-y-3 text-sm">
                    <div class="flex gap-2">
                        <select id="b-hour" class="flex-1 p-3 bg-slate-800 rounded-xl outline-none"></select>
                        <select id="b-min" class="flex-1 p-3 bg-slate-800 rounded-xl outline-none"></select>
                    </div>
                    <input type="text" id="b-car" class="w-full p-3 bg-slate-800 rounded-xl uppercase font-black" placeholder="차량번호">
                    <textarea id="b-memo" class="w-full p-3 bg-slate-800 rounded-xl h-24" placeholder="정비 내용"></textarea>
                    <button onclick="addBooking()" class="w-full py-4 bg-emerald-600 rounded-xl font-black">예약 확정</button>
                </div>
            </div>
        </div>
    </section>

    <section id="t-admin" class="tab-content px-4">
        <div class="max-w-4xl mx-auto">
            <div class="flex border-b border-slate-800 mb-6">
                <button onclick="adminTab('staff')" id="atab-staff" class="flex-1 py-4 font-black border-b-4 border-blue-500 text-blue-500">직원 승인</button>
                <button onclick="adminTab('client')" id="atab-client" class="flex-1 py-4 font-black border-b-4 border-transparent opacity-50">고객 승인</button>
            </div>
            <div id="approval-list" class="space-y-3"></div>
        </div>
    </section>

    <section id="t-stock" class="tab-content px-4">
        <div class="max-w-7xl mx-auto" id="stock-list-container">재고 로드 중...</div>
    </section>

    <script>
        // Firebase 및 초기 설정
        const firebaseConfig = {
            apiKey: "AIzaSyDhTPGNKNm38PSBdATs9lks0lYu52QrP3A",
            authDomain: "lkmotors-246f1.firebaseapp.com",
            databaseURL: "https://lkmotors-246f1-default-rtdb.firebaseio.com",
            projectId: "lkmotors-246f1",
            storageBucket: "lkmotors-246f1.firebasestorage.app",
            messagingSenderId: "389443224",
            appId: "1:389443224:web:c9b78c1afd3abc1c262aed"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let curUser = null;
        let selectedDate = "";
        let currentYear = 2026, currentMonth = 0; // 0이 1월

        // [인증]
        function toggleAuth(m) {
            document.getElementById('login-form').classList.toggle('hidden', m==='join');
            document.getElementById('join-form').classList.toggle('hidden', m==='login');
        }
        async function login() {
            const id = document.getElementById('uid').value, pw = document.getElementById('upw').value;
            if(id === "sansay333" && pw === "aa272728") { curUser = {id, type:'master'}; enter(); }
            else {
                const s = await db.ref('users/'+id).once('value');
                if(s.exists() && s.val().pw === pw) {
                    if(s.val().status === 'approved') { curUser = s.val(); enter(); }
                    else alert("승인 대기중입니다.");
                } else alert("로그인 실패");
            }
        }
        function join() {
            const id = document.getElementById('j-id').value, pw = document.getElementById('j-pw').value,
                  nm = document.getElementById('j-nm').value, tel = document.getElementById('j-tel').value, type = document.getElementById('j-type').value;
            db.ref('users/'+id).set({id, pw, nm, tel, type, status:'pending'}).then(()=> {alert("가입신청 완료!"); toggleAuth('login');});
        }
        function enter() {
            document.getElementById('auth-layer').style.display = 'none';
            document.getElementById('main-nav').style.display = 'flex';
            if(curUser.type === 'master') document.getElementById('btn-admin').classList.remove('hidden');
            showT('t-home');
        }

        // [컴나래 방식 차량 검색]
        function searchVehicle() {
            const car = document.getElementById('ext-car').value.toUpperCase();
            if(!car) return;
            db.ref('vehicles/'+car).once('value', s => {
                if(s.exists()) {
                    const v = s.val();
                    document.getElementById('ext-type').value = v.type||"";
                    document.getElementById('ext-vin').value = v.vin||"";
                    document.getElementById('ext-owner').value = v.owner||"";
                    document.getElementById('ext-tel').value = v.tel||"";
                    
                    // 명세서 즉시 반영
                    document.getElementById('v-car').value = car;
                    document.getElementById('v-type').value = v.type||"";
                    document.getElementById('v-vin').value = v.vin||"";
                    document.getElementById('v-owner-name').innerText = v.owner||"-";
                    document.getElementById('v-owner-tel').innerText = v.tel||"-";
                    loadHistory(car);
                } else alert("신규 차량입니다. 정보를 입력해 주세요.");
            });
        }

        function loadHistory(car) {
            db.ref('history/'+car).on('value', snap => {
                let h = "";
                snap.forEach(r => {
                    const d = r.val();
                    h += `<div class="p-2 bg-slate-800 rounded border-l-2 border-blue-500 cursor-pointer text-[10px]" onclick="loadRec('${car}','${r.key}')">
                        <b>${d.date_out}</b> - ₩${d.total.toLocaleString()}
                    </div>`;
                });
                document.getElementById('v-history-list').innerHTML = h || "이력 없음";
            });
        }

        // [캘린더 및 예약]
        function initTimeSelectors() {
            let h = ""; for(let i=8; i<=19; i++) h += `<option value="${i<10?'0'+i:i}">${i}시</option>`;
            document.getElementById('b-hour').innerHTML = h;
            let m = ""; for(let i=0; i<60; i+=10) m += `<option value="${i<10?'0'+i:i}">${i}분</option>`;
            document.getElementById('b-min').innerHTML = m;
        }

        function renderCalendar() {
            const first = new Date(currentYear, currentMonth, 1).getDay();
            const last = new Date(currentYear, currentMonth + 1, 0).getDate();
            document.getElementById('cal-month-title').innerText = `${currentYear}년 ${currentMonth + 1}월`;
            
            let html = "";
            for(let i=0; i<first; i++) html += `<div class="cal-day opacity-20"></div>`;
            
            db.ref('bookings').once('value', snap => {
                const counts = {};
                snap.forEach(b => { counts[b.val().date] = (counts[b.val().date] || 0) + 1; });

                for(let d=1; d<=last; d++) {
                    const dateStr = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    const cnt = counts[dateStr] ? `<div class="cal-count">[${counts[dateStr]}대]</div>` : "";
                    html += `<div class="cal-day" onclick="selectDate('${dateStr}')">
                        <div class="cal-num">${d}</div>${cnt}
                    </div>`;
                }
                document.getElementById('calendar-body').innerHTML = html;
            });
        }

        function selectDate(d) {
            selectedDate = d;
            document.getElementById('selected-date-title').innerText = d + " 예약 목록";
            db.ref('bookings').orderByChild('date').equalTo(d).on('value', snap => {
                let h = "";
                snap.forEach(b => {
                    const v = b.val();
                    h += `<div class="p-3 bg-slate-800 rounded-xl flex justify-between items-center text-sm">
                        <div><b class="text-blue-400">${v.time}</b> | <b>${v.car}</b><br><span class="opacity-50 text-xs">${v.memo}</span></div>
                        <button onclick="db.ref('bookings/${b.key}').remove()" class="text-red-500">×</button>
                    </div>`;
                });
                document.getElementById('day-booking-list').innerHTML = h || "예약 없음";
            });
        }

        function addBooking() {
            if(!selectedDate) return alert("달력에서 날짜를 먼저 선택하세요.");
            const car = document.getElementById('b-car').value.toUpperCase();
            if(!car) return alert("차량번호 필수");
            const time = document.getElementById('b-hour').value + ":" + document.getElementById('b-min').value;
            db.ref('bookings').push({date:selectedDate, time, car, memo:document.getElementById('b-memo').value}).then(()=> {
                alert("예약 완료"); renderCalendar();
            });
        }

        // [승인 관리]
        let currentAdminTab = 'staff';
        function adminTab(type) {
            currentAdminTab = type;
            document.getElementById('atab-staff').style.opacity = type==='staff'?'1':'0.5';
            document.getElementById('atab-client').style.opacity = type==='client'?'1':'0.5';
            loadUsers();
        }
        function loadUsers() {
            db.ref('users').on('value', snap => {
                let h = "";
                snap.forEach(uSnap => {
                    const u = uSnap.val();
                    if(u.type === currentAdminTab && u.status === 'pending') {
                        h += `<div class="p-4 bg-slate-900 rounded-2xl flex justify-between items-center shadow-lg border border-white/5">
                            <div><b class="text-xl">${u.nm}</b> <span class="text-blue-400">(${u.id})</span><br><span class="text-xs opacity-50">${u.tel}</span></div>
                            <button onclick="db.ref('users/${u.id}').update({status:'approved'})" class="bg-blue-600 px-6 py-2 rounded-xl font-black">승인하기</button>
                        </div>`;
                    }
                });
                document.getElementById('approval-list').innerHTML = h || "대기자 없음";
            });
        }

        // 탭 이동
        function showT(id) {
            document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id==='t-book') { renderCalendar(); initTimeSelectors(); }
            if(id==='t-admin') loadUsers();
        }

        function changeMonth(n) { currentMonth += n; if(currentMonth<0){currentMonth=11;currentYear--;} else if(currentMonth>11){currentMonth=0;currentYear++;} renderCalendar(); }

        // 명세서 행 초기화 및 공통 로직 (이전과 동일)
        function initBill() {
            const b = document.getElementById('bill-items'); b.innerHTML = "";
            for(let i=0; i<15; i++) {
                b.innerHTML += `<tr class="r-row">
                    <td><input class="i-nm input-bill"></td><td><input class="i-pn input-bill text-center"></td>
                    <td><input type="number" class="i-qt input-bill text-center" value="0" oninput="calc()"></td>
                    <td><input type="number" class="i-pr input-bill text-right" value="0" oninput="calc()"></td>
                    <td><input type="number" class="i-lb input-bill text-right" value="0" oninput="calc()"></td>
                    <td class="i-sum text-right font-black">0</td></tr>`;
            }
        }
