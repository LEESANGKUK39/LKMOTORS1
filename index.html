<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LKMOTORS ERP - ì •ë¹„Â·ì¬ê³ Â·ì˜ˆì•½ í†µí•© ì‹œìŠ¤í…œ</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f1f5f9; color: #1e293b; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        input { border: 1px solid #cbd5e1; padding: 10px; border-radius: 8px; outline: none; transition: 0.2s; }
        input:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); background-color: #fff; }
        
        /* ëª…ì„¸ì„œ í‘œ ìŠ¤íƒ€ì¼ */
        .bill-table { width: 100%; border-collapse: collapse; border: 2px solid #334155; }
        .bill-table th { background: #334155; color: white; padding: 10px; font-size: 14px; border: 1px solid #475569; }
        .bill-table td { border: 1px solid #94a3b8; padding: 0; background: white; }
        .bill-table input { border: none; width: 100%; height: 100%; border-radius: 0; padding: 10px; text-align: center; background: transparent; }
        .bill-table input:focus { background: #eff6ff; }
        
        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .print-only { display: block !important; }
            #bill-section { border: none !important; box-shadow: none !important; }
        }
    </style>
</head>
<body>

    <header class="no-print bg-slate-900 text-white p-4 sticky top-0 z-50 shadow-2xl">
        <div class="max-w-[1400px] mx-auto flex justify-between items-center">
            <h1 onclick="location.reload()" class="cursor-pointer font-black italic text-2xl text-blue-400 tracking-tighter">LKMOTORS <span class="text-white text-lg not-italic font-light ml-2">ERP SYSTEM</span></h1>
            <nav class="flex gap-2">
                <button onclick="switchTab('tab-repair')" class="nav-btn px-4 py-2 rounded-xl bg-slate-800 text-blue-400 font-bold">ì •ë¹„ëª…ì„¸ì„œ</button>
                <button onclick="switchTab('tab-stock')" class="nav-btn px-4 py-2 rounded-xl hover:bg-slate-800 font-bold">ì¬ê³ ê´€ë¦¬</button>
                <button onclick="switchTab('tab-booking')" class="nav-btn px-4 py-2 rounded-xl hover:bg-slate-800 font-bold">ì˜ˆì•½í˜„í™©</button>
            </nav>
        </div>
    </header>

    <main class="max-w-[1400px] mx-auto p-4 md:p-6">
        
        <section id="tab-repair" class="tab-content active space-y-6">
            <div class="bg-white p-6 rounded-[32px] shadow-xl border border-slate-200">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                    <div class="flex flex-col">
                        <label class="text-xs font-black text-slate-500 mb-1 ml-1">ì°¨ëŸ‰ë²ˆí˜¸ ì¡°íšŒ</label>
                        <div class="flex gap-2">
                            <input type="text" id="search-car" placeholder="12ê°€3456" class="flex-1 font-black text-xl uppercase border-2 border-blue-100">
                            <button onclick="searchCarAdmin()" class="no-print px-6 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition">ê²€ìƒ‰</button>
                        </div>
                    </div>
                    <div class="flex flex-col">
                        <label class="text-xs font-black text-slate-500 mb-1 ml-1">ì°¨ì£¼ëª…</label>
                        <input type="text" id="info-owner" class="font-bold text-lg">
                    </div>
                    <div class="flex flex-col">
                        <label class="text-xs font-black text-slate-500 mb-1 ml-1">ì—°ë½ì²˜</label>
                        <input type="text" id="info-phone" placeholder="010-0000-0000" class="font-bold text-lg">
                    </div>
                    <div class="flex flex-col">
                        <label class="text-xs font-black text-slate-500 mb-1 ml-1">í˜„ì¬ ì£¼í–‰ê±°ë¦¬(km)</label>
                        <input type="number" id="info-mileage" class="font-black text-lg text-blue-600">
                    </div>
                </div>

                <div id="bill-section" class="border-t-4 border-slate-900 pt-6">
                    <div class="flex justify-between items-end mb-4">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900 italic underline decoration-blue-500 underline-offset-8">ìë™ì°¨ ì •ë¹„ ëª…ì„¸ì„œ</h2>
                            <p class="text-slate-400 text-xs mt-3">â€» ì •ë¹„ ì´ë ¥ì€ ì‹œìŠ¤í…œì— 10ë…„ê°„ ë³´ê´€ë©ë‹ˆë‹¤.</p>
                        </div>
                        <div class="flex gap-3 text-sm no-print">
                            <div class="flex flex-col"><label class="font-bold text-slate-400 text-[10px]">ì •ë¹„ì¼ì</label><input type="date" id="r-date" class="p-1"></div>
                            <div class="flex flex-col"><label class="font-bold text-slate-400 text-[10px]">ì •ë¹„ì±…ì„ì</label><input type="text" id="r-staff" placeholder="ì„±í•¨" class="p-1 w-24"></div>
                        </div>
                    </div>

                    <table class="bill-table">
                        <thead>
                            <tr>
                                <th class="w-12">No</th>
                                <th>í’ˆë²ˆ ë° ë¶€í’ˆ/ì‘ì—…ë‚´ìš©</th>
                                <th class="w-20">ìˆ˜ëŸ‰</th>
                                <th class="w-32">ë‹¨ê°€</th>
                                <th class="w-32">ê³µê¸‰ê°€ì•¡</th>
                                <th class="w-32">ê³µì„(ê¸°ìˆ ë£Œ)</th>
                                <th class="w-12 no-print"></th>
                            </tr>
                        </thead>
                        <tbody id="repair-items-container">
                            </tbody>
                        <tfoot>
                            <tr class="bg-slate-50">
                                <td colspan="4" class="p-5 text-right font-black text-slate-600 text-lg">ìµœì¢… í•©ê³„ ê¸ˆì•¡ (VAT ë³„ë„) :</td>
                                <td colspan="3" id="total-display" class="p-5 text-right font-black text-3xl text-blue-600">â‚© 0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="mt-8 flex gap-4 no-print">
                    <button onclick="addRow()" class="px-8 bg-slate-200 font-black rounded-2xl hover:bg-slate-300 transition">ì¤„ ì¶”ê°€</button>
                    <button onclick="saveDetailedRepair()" class="flex-1 py-5 bg-slate-900 text-white rounded-[20px] font-black text-2xl shadow-2xl hover:scale-[1.01] transition">ì •ë¹„ ì™„ë£Œ ë° ëª…ì„¸ì„œ ì €ì¥</button>
                    <button onclick="window.print()" class="px-8 bg-slate-700 text-white font-black rounded-2xl">ğŸ“„ ëª…ì„¸ì„œ ì¸ì‡„</button>
                </div>
            </div>

            <div id="history-area" class="mt-12 no-print">
                <h3 class="text-xl font-black text-slate-800 mb-6 flex items-center gap-2 italic">
                    <span class="w-2 h-8 bg-blue-500 rounded-full"></span> PREVIOUS SERVICE HISTORY
                </h3>
                <div id="repair-history-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p class="col-span-full text-center py-20 text-slate-400 font-bold border-2 border-dashed rounded-[32px]">ì°¨ëŸ‰ë²ˆí˜¸ ì¡°íšŒ ì‹œ ê³¼ê±° 10ë…„ ê¸°ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>
            </div>
        </section>

        <section id="tab-stock" class="tab-content space-y-6">
            <div class="bg-white p-8 rounded-[32px] shadow-xl">
                <h3 class="text-2xl font-black mb-6 text-green-600 italic">ë¶€í’ˆ ë° ì¬ê³  ë“±ë¡</h3>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <input type="text" id="stock-pn" placeholder="ë¶€í’ˆë²ˆí˜¸(PN)" class="font-bold border-green-100">
                    <input type="text" id="stock-name" placeholder="ë¶€í’ˆëª…">
                    <input type="number" id="stock-in-price" placeholder="ì…ê³ ê°€(ë‹¨ê°€)">
                    <input type="number" id="stock-out-price" placeholder="ì¶œê³ ê°€(ë‹¨ê°€)">
                    <input type="number" id="stock-count" placeholder="í˜„ì¬ê³  ìˆ˜ëŸ‰">
                    <button onclick="saveStock()" class="col-span-full py-4 bg-green-600 text-white rounded-2xl font-black text-lg shadow-lg">ë¶€í’ˆ ë“±ë¡í•˜ê¸°</button>
                </div>
            </div>
            <div class="bg-white rounded-[32px] shadow-xl overflow-hidden border">
                <table class="w-full text-center">
                    <thead class="bg-slate-900 text-white">
                        <tr><th class="p-4">ë¶€í’ˆë²ˆí˜¸</th><th class="p-4">ë¶€í’ˆëª…</th><th class="p-4">í˜„ì¬ê³ </th><th class="p-4">ì…ê³ ê°€</th><th class="p-4 text-green-400">ì •ë¹„ë‹¨ê°€</th></tr>
                    </thead>
                    <tbody id="stock-table-body" class="divide-y divide-slate-100 font-bold"></tbody>
                </table>
            </div>
        </section>

        <section id="tab-booking" class="tab-content space-y-6">
            <div class="bg-white p-8 rounded-[32px] shadow-xl">
                <h3 class="text-2xl font-black mb-6 italic text-blue-600">ì‹ ê·œ ì •ë¹„ ì˜ˆì•½</h3>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <input type="date" id="book-date">
                    <input type="time" id="book-time">
                    <input type="text" id="book-car" placeholder="ì°¨ëŸ‰ë²ˆí˜¸" class="uppercase">
                    <input type="text" id="book-desc" placeholder="ì •ë¹„ ì˜ˆì • ë‚´ìš©">
                    <button onclick="saveBooking()" class="bg-blue-600 text-white rounded-xl font-bold">ì˜ˆì•½ ì €ì¥</button>
                </div>
            </div>
            <div id="booking-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>
    </main>

    <script>
        // 1. íŒŒì´ì–´ë² ì´ìŠ¤ ì´ˆê¸°í™”
        const firebaseConfig = {
            apiKey: "AIzaSyDhTPGNKNm38PSBdATs9lks0lYu52QrP3A",
            authDomain: "lkmotors-246f1.firebaseapp.com",
            databaseURL: "https://lkmotors-246f1-default-rtdb.firebaseio.com",
            projectId: "lkmotors-246f1",
            storageBucket: "lkmotors-246f1.firebasestorage.app",
            messagingSenderId: "389443224",
            appId: "1:389443224:web:c9b78c1afd3abc1c262aed"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ì´ˆê¸° ì‹¤í–‰
        window.onload = () => {
            for(let i=0; i<10; i++) addRow();
            document.getElementById('r-date').value = new Date().toISOString().substring(0, 10);
            loadStocks();
            loadBookings();
        };

        // [íƒ­ ì „í™˜]
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('bg-slate-800', 'text-blue-400'));
            document.getElementById(id).classList.add('active');
            event.currentTarget.classList.add('bg-slate-800', 'text-blue-400');
            if(id === 'tab-stock') loadStocks();
            if(id === 'tab-booking') loadBookings();
        }

        // [ì •ë¹„ ëª…ì„¸ì„œ ë¡œì§]
        function addRow() {
            const container = document.getElementById('repair-items-container');
            const rowCount = container.children.length + 1;
            const tr = document.createElement('tr');
            tr.className = "item-row";
            tr.innerHTML = `
                <td class="bg-slate-50 text-slate-400 font-bold">${rowCount}</td>
                <td><input type="text" class="item-key text-left px-4 font-bold" placeholder="ë¶€í’ˆëª… ë˜ëŠ” í’ˆë²ˆ"></td>
                <td><input type="number" value="1" class="item-qty" oninput="updateCalc(this)"></td>
                <td><input type="number" placeholder="0" class="item-part text-right" oninput="updateCalc(this)"></td>
                <td class="item-subtotal text-right px-4 font-black bg-slate-50">0</td>
                <td><input type="number" placeholder="0" class="item-labor text-right font-bold text-blue-500" oninput="updateCalc(this)"></td>
                <td class="no-print"><button onclick="this.parentElement.parentElement.remove(); calcFinalTotal();" class="text-red-400 font-black text-xl">Ã—</button></td>
            `;
            container.appendChild(tr);
        }

        function updateCalc(input) {
            const row = input.closest('tr');
            const qty = parseInt(row.querySelector('.item-qty').value) || 0;
            const part = parseInt(row.querySelector('.item-part').value) || 0;
            row.querySelector('.item-subtotal').innerText = (qty * part).toLocaleString();
            calcFinalTotal();
        }

        function calcFinalTotal() {
            let total = 0;
            document.querySelectorAll('.item-row').forEach(row => {
                const qty = parseInt(row.querySelector('.item-qty').value) || 0;
                const part = parseInt(row.querySelector('.item-part').value) || 0;
                const labor = parseInt(row.querySelector('.item-labor').value) || 0;
                total += (qty * part) + labor;
            });
            document.getElementById('total-display').innerText = "â‚© " + total.toLocaleString();
            return total;
        }

        // [ì¡°íšŒ ë° 10ë…„ ì´ë ¥ ë¡œë“œ]
        async function searchCarAdmin() {
            const carNum = document.getElementById('search-car').value.toUpperCase().trim();
            if(!carNum) return;

            database.ref('cars/' + carNum).once('value', snap => {
                const info = snap.val();
                if(info) {
                    document.getElementById('info-owner').value = info.owner || "";
                    document.getElementById('info-phone').value = info.phone || "";
                    document.getElementById('info-mileage').value = info.mileage || "";
                }
            });
            loadRepairHistory(carNum);
        }

        async function saveDetailedRepair() {
            const carNum = document.getElementById('search-car').value.toUpperCase().trim();
            if(!carNum) { alert("ì°¨ëŸ‰ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

            const items = [];
            const rows = document.querySelectorAll('.item-row');
            for (let row of rows) {
                const key = row.querySelector('.item-key').value.trim();
                const qty = parseInt(row.querySelector('.item-qty').value) || 0;
                const part = parseInt(row.querySelector('.item-part').value) || 0;
                const labor = parseInt(row.querySelector('.item-labor').value) || 0;
                if(key) {
                    items.push({ name: key, quantity: qty, partPrice: part, laborPrice: labor });
                    await deductStock(key, qty);
                }
            }

            const data = {
                date: document.getElementById('r-date').value,
                staff: document.getElementById('r-staff').value,
                mileage: document.getElementById('info-mileage').value,
                items: items,
                total: calcFinalTotal(),
                createdAt: Date.now()
            };

            await database.ref('repairs/' + carNum).push(data);
            await database.ref('cars/' + carNum).update({
                owner: document.getElementById('info-owner').value,
                phone: document.getElementById('info-phone').value,
                mileage: data.mileage
            });

            alert("ëª…ì„¸ì„œ ì €ì¥ ë° ì¬ê³  ì°¨ê°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            loadRepairHistory(carNum);
        }

        async function deductStock(key, qty) {
            const snapshot = await database.ref('stocks').once('value');
            const stocks = snapshot.val();
            if(!stocks) return;
            for(let id in stocks) {
                if(id === key || stocks[id].name === key) {
                    const newCount = (parseInt(stocks[id].count) || 0) - qty;
                    await database.ref('stocks/' + id).update({ count: newCount });
                    break;
                }
            }
        }

        function loadRepairHistory(car) {
            database.ref('repairs/' + car).limitToLast(100).once('value', snap => {
                const data = snap.val();
                let html = "";
                if(data) {
                    Object.values(data).reverse().forEach(r => {
                        html += `
                        <div class="bg-white p-6 rounded-[24px] shadow-sm border border-slate-200 hover:border-blue-500 transition cursor-pointer">
                            <div class="flex justify-between items-center mb-3 border-b pb-2">
                                <span class="font-black text-slate-700">${r.date}</span>
                                <span class="font-black text-blue-600">â‚©${Number(r.total).toLocaleString()}</span>
                            </div>
                            <div class="text-sm text-slate-500 space-y-1">
                                ${r.items.map(i => `â€¢ ${i.name} (x${i.quantity})`).join('<br>')}
                            </div>
                            <div class="mt-4 text-[10px] text-slate-300 font-bold text-right italic">${r.mileage || 0} km / ì •ë¹„ì‚¬: ${r.staff || 'ë¯¸ì§€ì •'}</div>
                        </div>`;
                    });
                }
                document.getElementById('repair-history-list').innerHTML = html || "<p class='col-span-full text-center py-20 text-slate-400 font-bold'>ì •ë¹„ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
            });
        }

        // [ì¬ê³  ê´€ë¦¬ ë¡œì§]
        function saveStock() {
            const pn = document.getElementById('stock-pn').value.trim();
            const name = document.getElementById('stock-name').value.trim();
            const count = parseInt(document.getElementById('stock-count').value) || 0;
            if(!pn || !name) return;
            database.ref('stocks/' + pn).set({
                pn, name, count,
                inPrice: document.getElementById('stock-in-price').value,
                outPrice: document.getElementById('stock-out-price').value
            }).then(() => { alert("ì¬ê³  ë“±ë¡ ì™„ë£Œ"); loadStocks(); });
        }

        function loadStocks() {
            database.ref('stocks').once('value', snap => {
                const data = snap.val();
                let html = "";
                for(let k in data) {
                    html += `<tr class="hover:bg-slate-50">
                        <td class="p-4 font-mono text-xs">${data[k].pn}</td>
                        <td class="p-4 text-left font-bold text-slate-700">${data[k].name}</td>
                        <td class="p-4 font-black ${data[k].count < 5 ? 'text-red-500':'text-blue-600'}">${data[k].count}</td>
                        <td class="p-4 text-slate-400 text-sm">â‚©${Number(data[k].inPrice).toLocaleString()}</td>
                        <td class="p-4 text-green-600 font-black">â‚©${Number(data[k].outPrice).toLocaleString()}</td>
                    </tr>`;
                }
                document.getElementById('stock-table-body').innerHTML = html;
            });
        }

        // [ì˜ˆì•½ ê´€ë¦¬ ë¡œì§]
        function saveBooking() {
            const date = document.getElementById('book-date').value;
            const time = document.getElementById('book-time').value;
            const car = document.getElementById('book-car').value.toUpperCase();
            if(!date || !car) return;
            database.ref('bookings').push({ date, time, car, desc: document.getElementById('book-desc').value })
            .then(() => { alert("ì˜ˆì•½ ì €ì¥ ì™„ë£Œ"); loadBookings(); });
        }

        function loadBookings() {
            database.ref('bookings').once('value', snap => {
                const data = snap.val();
                let html = "";
                for(let k in data) {
                    html += `
                    <div class="bg-white p-6 rounded-[24px] shadow-sm border-l-8 border-blue-500">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-black text-2xl text-slate-800">${data[k].car}</span>
                            <span class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-xs font-black">${data[k].time}</span>
                        </div>
                        <p class="text-sm font-bold text-slate-400 mb-3">${data[k].date}</p>
                        <p class="bg-slate-50 p-4 rounded-xl text-slate-600 font-medium">${data[k].desc}</p>
                    </div>`;
                }
                document.getElementById('booking-list').innerHTML = html || "<p class='col-span-full text-center py-20 text-slate-400 font-bold font-italic'>ë“±ë¡ëœ ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
            });
        }
    </script>
</body>
</html>
